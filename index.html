<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sales Summary</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    #total-sales { min-width: 6rem; text-align: right; }
  </style>
</head>
<body>
  <main class="container py-5">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <h1 class="mb-4">Sales Summary</h1>
        <div class="card shadow-sm">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <h5 class="card-title mb-0">Total Sales</h5>
              <p class="text-muted mb-0">Sum of the "Sales" column from data.csv</p>
            </div>
            <div id="total-sales" class="fs-3 fw-bold">Loading...</div>
          </div>
        </div>
        <div id="error" class="mt-3 text-danger" role="alert" style="display:none;"></div>
      </div>
    </div>
  </main>

  <script>
    // Ensure the document title is set as required
    document.title = 'Sales Summary';

    // Simple CSV line parser that supports quoted fields and escaped quotes
    function parseCsvLine(line) {
      const fields = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
          // Handle escaped double quotes ("")
          if (inQuotes && line[i + 1] === '"') {
            cur += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
          continue;
        }
        if (ch === ',' && !inQuotes) {
          fields.push(cur);
          cur = '';
          continue;
        }
        cur += ch;
      }
      fields.push(cur);
      return fields;
    }

    async function fetchAndSumSales() {
      const resp = await fetch('data.csv', { cache: 'no-store' });
      if (!resp.ok) throw new Error('Failed to fetch data.csv (' + resp.status + ')');
      const text = await resp.text();
      const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
      if (lines.length === 0) return 0;

      const header = parseCsvLine(lines[0]).map(h => h.trim());
      const salesIndex = header.findIndex(h => h.toLowerCase() === 'sales');
      if (salesIndex === -1) throw new Error('No "Sales" column found in data.csv');

      let sum = 0;
      for (let i = 1; i < lines.length; i++) {
        const row = parseCsvLine(lines[i]);
        if (salesIndex >= row.length) continue;
        let raw = row[salesIndex].trim();
        // Remove surrounding quotes if present
        if ((raw.startsWith('"') && raw.endsWith('"')) || (raw.startsWith("'") && raw.endsWith("'"))) {
          raw = raw.slice(1, -1);
        }
        if (raw === '') continue;
        // Try to parse number, allowing commas as thousands separators
        let num = Number(raw.replace(/,/g, ''));
        if (!isFinite(num)) continue;
        sum += num;
      }
      return sum;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const out = document.getElementById('total-sales');
      const errEl = document.getElementById('error');
      try {
        const total = await fetchAndSumSales();
        // Format: integer without decimals, otherwise two decimals
        const formatted = Number.isInteger(total)
          ? total.toLocaleString()
          : total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        out.textContent = formatted;
      } catch (err) {
        out.textContent = 'â€”';
        errEl.style.display = 'block';
        errEl.textContent = err && err.message ? err.message : String(err);
        console.error(err);
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>